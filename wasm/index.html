
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Labs for the Tetrate Envoy and Serivce Mesh Immersion Day at Kubecon EU 2022">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.8">
    
    
      
        <title>Extending Envoy and Istio with Wasm - Tetrate Envoy and Service Mesh Immersion Day</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6e60f8b8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#extending-envoy-and-istio-with-wasm" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Tetrate Envoy and Service Mesh Immersion Day" class="md-header__button md-logo" aria-label="Tetrate Envoy and Service Mesh Immersion Day" data-md-component="logo">
      <img id="logo_light_mode" src="../assets/tetrate-logo-white.png" alt="logo">
<img id="logo_dark_mode" src="../assets/tetrate-logo-black.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tetrate Envoy and Service Mesh Immersion Day
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Extending Envoy and Istio with Wasm
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/tetratelabs/kubecon-eu-immersion-day/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Tetrate Envoy and Service Mesh Immersion Day" class="md-nav__button md-logo" aria-label="Tetrate Envoy and Service Mesh Immersion Day" data-md-component="logo">
      <img id="logo_light_mode" src="../assets/tetrate-logo-white.png" alt="logo">
<img id="logo_dark_mode" src="../assets/tetrate-logo-black.png" alt="logo">

    </a>
    Tetrate Envoy and Service Mesh Immersion Day
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tetratelabs/kubecon-eu-immersion-day/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../envoy/" class="md-nav__link">
        Introduction to Envoy
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../istio/" class="md-nav__link">
        Introduction to Istio
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Extending Envoy and Istio with Wasm
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Extending Envoy and Istio with Wasm
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#envoy-wasm-filter" class="md-nav__link">
    Envoy Wasm filter
  </a>
  
    <nav class="md-nav" aria-label="Envoy Wasm filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-wasm-filter" class="md-nav__link">
    Using the Wasm filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-wasm-extension" class="md-nav__link">
    Building a Wasm Extension
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#istio-wasmplugin-resource" class="md-nav__link">
    Istio WasmPlugin resource
  </a>
  
    <nav class="md-nav" aria-label="Istio WasmPlugin resource">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-the-wasm-image" class="md-nav__link">
    Building the Wasm image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-wasmplugin-resource" class="md-nav__link">
    Creating WasmPlugin resource
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../summary/" class="md-nav__link">
        Summary
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#envoy-wasm-filter" class="md-nav__link">
    Envoy Wasm filter
  </a>
  
    <nav class="md-nav" aria-label="Envoy Wasm filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-wasm-filter" class="md-nav__link">
    Using the Wasm filter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-wasm-extension" class="md-nav__link">
    Building a Wasm Extension
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#istio-wasmplugin-resource" class="md-nav__link">
    Istio WasmPlugin resource
  </a>
  
    <nav class="md-nav" aria-label="Istio WasmPlugin resource">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-the-wasm-image" class="md-nav__link">
    Building the Wasm image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-wasmplugin-resource" class="md-nav__link">
    Creating WasmPlugin resource
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/tetratelabs/kubecon-eu-immersion-day/edit/master/docs/wasm.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="extending-envoy-and-istio-with-wasm">Extending Envoy and Istio with Wasm<a class="headerlink" href="#extending-envoy-and-istio-with-wasm" title="Permanent link">&para;</a></h1>
<h2 id="envoy-wasm-filter">Envoy Wasm filter<a class="headerlink" href="#envoy-wasm-filter" title="Permanent link">&para;</a></h2>
<p>Let's look more closely at the Envoy configuration from the previous section:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nv">HTTPBIN_POD</span><span class="o">=</span><span class="k">$(</span>kubectl get pod -l <span class="nv">app</span><span class="o">=</span>httpbin -ojsonpath<span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span>
</code></pre></div>
<p>We'll use the <code>/config_dump</code> endpoint on the Envoy proxy container in the pod to get a full Envoy configuration dump:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>kubectl <span class="nb">exec</span> -it <span class="nv">$HTTPBIN_POD</span> -c istio-proxy -- curl localhost:15000/config_dump &gt; envoy.json
</code></pre></div>
<p>Because the configuration is enormous, let's search for the <code>type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm</code>. Here's a snippet:</p>
<details class="tldr">
<summary>wasm-filter.json</summary>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="err">...</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">&quot;default_filter_chain&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="nt">&quot;filters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">      </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;istio.stats&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">      </span><span class="nt">&quot;typed_config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">        </span><span class="nt">&quot;@type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;type.googleapis.com/udpa.type.v1.TypedStruct&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">        </span><span class="nt">&quot;type_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">        </span><span class="nt">&quot;config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">          </span><span class="nt">&quot;root_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stats_outbound&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">          </span><span class="nt">&quot;vm_config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">          </span><span class="nt">&quot;vm_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tcp_stats_outbound&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">          </span><span class="nt">&quot;runtime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;envoy.wasm.runtime.null&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">          </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">            </span><span class="nt">&quot;local&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">            </span><span class="nt">&quot;inline_string&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;envoy.wasm.stats&quot;</span><span class="w"></span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">          </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="err">...</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
</details>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There will be more than one instance of the <code>type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm</code> filter in the configuration. The <code>envoy.wasm.stats</code> extension gets executed on multiple paths for multiple listeners.</p>
</div>
<p>The <code>istio.stats</code> extension is a Wasm extension built into Envoy. How do we know that? Well, the built-in extensions use the <code>envoy.wasm.runtime.null</code> runtime. If we wanted to run our Wasm extension, we could bundle it with Envoy. However, there are easier ways to do this.</p>
<p>We can tell Envoy to load a Wasm extension from a specific <code>.wasm</code> file we provide in the configuration. We don't have to rebuild Envoy and maintain our Envoy binary.</p>
<h3 id="using-the-wasm-filter">Using the Wasm filter<a class="headerlink" href="#using-the-wasm-filter" title="Permanent link">&para;</a></h3>
<p>To configure a Wasm extension, we use a HTTP filter called <code>envoy.extensions.filters.network.wasm.v3.Wasm</code>. Since this is a HTTP filter, we know we have to configure it inside the <code>http_filters</code> section right before the router filter (<code>envoy.filters.http.router</code>).</p>
<p>Let's use the Envoy configuration we're already familiar with and see if we can figure out how to configure Envoy to load a Wasm extension.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nn">...</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="nt">filter_chains</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">filters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.network.http_connection_manager</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">        </span><span class="nt">typed_config</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">          </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span><span class="w"></span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">          </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello_world_service</span><span class="w"></span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">          </span><span class="nt">http_filters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="hll"><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.wasm</span><span class="w"></span>
</span><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="hll"><span class="w">            </span><span class="nt">typed_config</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="hll"><span class="w">              </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/udpa.type.v1.TypedStruct</span><span class="w"></span>
</span><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="hll"><span class="w">              </span><span class="nt">type_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm</span><span class="w"></span>
</span><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="hll"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="hll"><span class="w">                </span><span class="nt">config</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="hll"><span class="w">                  </span><span class="nt">vm_config</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="hll"><span class="w">                    </span><span class="nt">vm_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my_vm&quot;</span><span class="w"></span>
</span><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="hll"><span class="w">                    </span><span class="nt">runtime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;envoy.wasm.runtime.v8&quot;</span><span class="w"> </span><span class="c1"># (1)</span><span class="w"></span>
</span><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="hll"><span class="w">                    </span><span class="nt">code</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="hll"><span class="w">                      </span><span class="nt">local</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="hll"><span class="w">                        </span><span class="nt">filename</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;main.wasm&quot;</span><span class="w"> </span><span class="c1"># (2)</span><span class="w"></span>
</span><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.router</span><span class="w"></span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">          </span><span class="nt">route_config</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<ol>
<li>To tell Envoy our extension is not built-in, we use the <code>envoy.wasm.runtime.v8</code> runtime.</li>
<li>We provide the <code>main.wasm</code> file that contains our extension. Note that we could replace <code>local</code> with <code>remote</code> and point to an URL instead.</li>
</ol>
<p>Make sure you run the two Docker containers from the first section:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>docker run -d -p <span class="m">8100</span>:80 kennethreitz/httpbin
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>docker run -d -p <span class="m">8200</span>:80 kennethreitz/httpbin
</code></pre></div>
<p>Because we'll be building a Wasm extension, let's create a separate folder for it so that we can store all files in the same place:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>mkdir wasm-extension <span class="o">&amp;&amp;</span> <span class="nb">cd</span> wasm-extension
</code></pre></div>
<p>We can now run func-e with the following configuration:</p>
<div class="admonition tldr">
<p class="admonition-title">envoy-config.yaml</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span>
<span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span>
<span class="normal"><a href="#__codelineno-6-54">54</a></span>
<span class="normal"><a href="#__codelineno-6-55">55</a></span>
<span class="normal"><a href="#__codelineno-6-56">56</a></span>
<span class="normal"><a href="#__codelineno-6-57">57</a></span>
<span class="normal"><a href="#__codelineno-6-58">58</a></span>
<span class="normal"><a href="#__codelineno-6-59">59</a></span>
<span class="normal"><a href="#__codelineno-6-60">60</a></span>
<span class="normal"><a href="#__codelineno-6-61">61</a></span>
<span class="normal"><a href="#__codelineno-6-62">62</a></span>
<span class="normal"><a href="#__codelineno-6-63">63</a></span>
<span class="normal"><a href="#__codelineno-6-64">64</a></span>
<span class="normal"><a href="#__codelineno-6-65">65</a></span>
<span class="normal"><a href="#__codelineno-6-66">66</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nt">static_resources</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">listener_0</span><span class="w"></span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">      </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0</span><span class="w"></span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">        </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span><span class="w"></span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="nt">filter_chains</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">filters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.network.http_connection_manager</span><span class="w"></span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">        </span><span class="nt">typed_config</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">          </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span><span class="w"></span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">          </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello_world_service</span><span class="w"></span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">          </span><span class="nt">http_filters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="hll"><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.wasm</span><span class="w"></span>
</span><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="hll"><span class="w">            </span><span class="nt">typed_config</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="hll"><span class="w">              </span><span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/udpa.type.v1.TypedStruct</span><span class="w"></span>
</span><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="hll"><span class="w">              </span><span class="nt">type_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm</span><span class="w"></span>
</span><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="hll"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="hll"><span class="w">                </span><span class="nt">config</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="hll"><span class="w">                  </span><span class="nt">vm_config</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="hll"><span class="w">                    </span><span class="nt">vm_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;my_vm&quot;</span><span class="w"></span>
</span><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="hll"><span class="w">                    </span><span class="nt">runtime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;envoy.wasm.runtime.v8&quot;</span><span class="w"></span>
</span><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="hll"><span class="w">                    </span><span class="nt">code</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="hll"><span class="w">                      </span><span class="nt">local</span><span class="p">:</span><span class="w"></span>
</span><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="hll"><span class="w">                        </span><span class="nt">filename</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;main.wasm&quot;</span><span class="w"></span>
</span><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.router</span><span class="w"></span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">          </span><span class="nt">route_config</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_first_route</span><span class="w"></span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">            </span><span class="nt">virtual_hosts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_vhost</span><span class="w"></span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">              </span><span class="nt">domains</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">              </span><span class="nt">routes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">                  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/one&quot;</span><span class="w"></span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">                </span><span class="nt">route</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">                  </span><span class="nt">prefix_rewrite</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/ip&quot;</span><span class="w"></span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">                  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello_world_cluster</span><span class="w"></span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">                  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/two&quot;</span><span class="w"></span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">                </span><span class="nt">route</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">                  </span><span class="nt">prefix_rewrite</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/user-agent&quot;</span><span class="w"></span>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">                  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">second_cluster</span><span class="w"></span>
<a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">  </span><span class="nt">clusters</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello_world_cluster</span><span class="w"></span>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">    </span><span class="nt">connect_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span><span class="w"></span>
<a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="nt">load_assignment</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">      </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello_world_cluster</span><span class="w"></span>
<a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">      </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-50" name="__codelineno-6-50"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lb_endpoints</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">            </span><span class="nt">address</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="w">              </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">                </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span><span class="w"></span>
<a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">                </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8100</span><span class="w"></span>
<a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">second_cluster</span><span class="w"></span>
<a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">    </span><span class="nt">connect_timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span><span class="w"></span>
<a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">    </span><span class="nt">load_assignment</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="w">      </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">second_cluster</span><span class="w"></span>
<a id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="w">      </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lb_endpoints</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="w">            </span><span class="nt">address</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="w">              </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-65" name="__codelineno-6-65"></a><span class="w">                </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span><span class="w"></span>
<a id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="w">                </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8200</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>func-e run -c envoy-config.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="go">[2022-04-28 19:03:46.607][2672][critical][main] [source/server/server.cc:114] error initializing configuration &#39;envoy-config.yaml&#39;: Invalid path: main.wasm</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="go">[2022-04-28 19:03:46.607][2672][info][main] [source/server/server.cc:891] exiting</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="go">Invalid path: main.wasm</span>
</code></pre></div>
<p>It should fail because there's no <code>main.wasm</code> file. Let's build one!</p>
<h3 id="building-a-wasm-extension">Building a Wasm Extension<a class="headerlink" href="#building-a-wasm-extension" title="Permanent link">&para;</a></h3>
<p>We'll build a simple Wasm extension that adds a custom response HTTP header to all requests.</p>
<p>From the <code>wasm-extension</code> folder, let's initialize the Go module:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>go mod init wasm-extension
</code></pre></div>
<p>Next, let's create the <code>main.go</code> file where the code for our Wasm extension will live:</p>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">main.go</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span>
<span class="normal"><a href="#__codelineno-10-51">51</a></span>
<span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="s">&quot;github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm&quot;</span><span class="w"></span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="s">&quot;github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types&quot;</span><span class="w"></span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="p">)</span><span class="w"></span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">SetVMContext</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmContext</span><span class="p">{})</span><span class="w"></span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="kd">type</span><span class="w"> </span><span class="nx">vmContext</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="c1">// Embed the default VM context here,</span><span class="w"></span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="c1">// so that we don&#39;t need to reimplement all the methods.</span><span class="w"></span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">    </span><span class="nx">types</span><span class="p">.</span><span class="nx">DefaultVMContext</span><span class="w"></span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="c1">// Override types.DefaultVMContext.</span><span class="w"></span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">vmContext</span><span class="p">)</span><span class="w"> </span><span class="nx">NewPluginContext</span><span class="p">(</span><span class="nx">contextID</span><span class="w"> </span><span class="kt">uint32</span><span class="p">)</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">PluginContext</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">pluginContext</span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="kd">type</span><span class="w"> </span><span class="nx">pluginContext</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">    </span><span class="c1">// Embed the default plugin context here,</span><span class="w"></span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">    </span><span class="c1">// so that we don&#39;t need to reimplement all the methods.</span><span class="w"></span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">    </span><span class="nx">types</span><span class="p">.</span><span class="nx">DefaultPluginContext</span><span class="w"></span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="c1">// Override types.DefaultPluginContext.</span><span class="w"></span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">pluginContext</span><span class="p">)</span><span class="w"> </span><span class="nx">NewHttpContext</span><span class="p">(</span><span class="nx">contextID</span><span class="w"> </span><span class="kt">uint32</span><span class="p">)</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">HttpContext</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">    </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">LogInfo</span><span class="p">(</span><span class="s">&quot;NewHttpContext&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">httpContext</span><span class="p">{</span><span class="nx">contextID</span><span class="p">:</span><span class="w"> </span><span class="nx">contextID</span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="hll"><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="o">*</span><span class="nx">httpContext</span><span class="p">)</span><span class="w"> </span><span class="nx">OnHttpResponseHeaders</span><span class="p">(</span><span class="nx">numHeaders</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">endOfStream</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Action</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="hll"><span class="w">    </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">LogInfo</span><span class="p">(</span><span class="s">&quot;OnHttpResponseHeaders&quot;</span><span class="p">)</span><span class="w"></span>
</span><a id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="hll">
</span><a id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="hll"><span class="w">    </span><span class="nx">key</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;x-custom-header&quot;</span><span class="w"></span>
</span><a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="hll"><span class="w">    </span><span class="nx">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;custom-value&quot;</span><span class="w"></span>
</span><a id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="hll">
</span><a id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">AddHttpResponseHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><a id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="hll"><span class="w">        </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">LogCriticalf</span><span class="p">(</span><span class="s">&quot;failed to add header: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
</span><a id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">ActionPause</span><span class="w"></span>
</span><a id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="hll"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><a id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="hll"><span class="w">    </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">LogInfof</span><span class="p">(</span><span class="s">&quot;header set: %s=%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
</span><a id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">ActionContinue</span><span class="w"></span>
</span><a id="__codelineno-10-47" name="__codelineno-10-47"></a><span class="hll"><span class="p">}</span><span class="w"></span>
</span><a id="__codelineno-10-48" name="__codelineno-10-48"></a>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a><span class="kd">type</span><span class="w"> </span><span class="nx">httpContext</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a><span class="w">    </span><span class="c1">// Embed the default http context here,</span><span class="w"></span>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a><span class="w">    </span><span class="c1">// so that we don&#39;t need to reimplement all the methods.</span><span class="w"></span>
<a id="__codelineno-10-52" name="__codelineno-10-52"></a><span class="w">    </span><span class="nx">types</span><span class="p">.</span><span class="nx">DefaultHttpContext</span><span class="w"></span>
<a id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="w">    </span><span class="nx">contextID</span><span class="w"> </span><span class="kt">uint32</span><span class="w"></span>
<a id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<p>Save the above to <code>main.go</code>.</p>
<p>In the <code>main.go</code> file we defined a couple of functions that will be called by Envoy when the extension is loaded or when the requests are being processed. The part where we add the custom response header is in the <code>OnHttpResponseHeaders</code> function, as shown below:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="o">*</span><span class="nx">httpContext</span><span class="p">)</span><span class="w"> </span><span class="nx">OnHttpResponseHeaders</span><span class="p">(</span><span class="nx">numHeaders</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">endOfStream</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">Action</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">  </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">LogInfo</span><span class="p">(</span><span class="s">&quot;OnHttpResponseHeaders&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)</span><span class="w"></span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="nx">key</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;x-custom-header&quot;</span><span class="w"></span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">  </span><span class="nx">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;custom-value&quot;</span><span class="w"></span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">AddHttpResponseHeader</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (2)</span><span class="w"></span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">LogCriticalf</span><span class="p">(</span><span class="s">&quot;failed to add header: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">ActionPause</span><span class="w"> </span><span class="c1">// (3)</span><span class="w"></span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">  </span><span class="nx">proxywasm</span><span class="p">.</span><span class="nx">LogInfof</span><span class="p">(</span><span class="s">&quot;header set: %s=%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">types</span><span class="p">.</span><span class="nx">ActionContinue</span><span class="w"> </span><span class="c1">// (4)</span><span class="w"></span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<ol>
<li>ProxyWasm library has built-in functions for logging.</li>
<li>We can <code>AddHttpResponseHeader</code> to add a custom response header.</li>
<li>In case of an error, we return <code>types.ActionPause</code> to tell Envoy to stop executing subsequent filters.</li>
<li>If there are no errors, we continue with the execution.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Proxy Wasm Go SDK API</p>
<p>The SDK API is in the <code>proxywasm</code> package included in the source code. The SDK provides a set of functions we can use to interact with the Envoy proxy and/or the requests and responses. It contains functions for adding and manipulating HTTP headers, body, logging functions, and other APIs for using shared queues, shared data, and more.</p>
</div>
<p>To build the extension, we'll use the <a href="https://tinygo.org">TinyGo compiler</a> - follow <a href="https://tetratelabs.github.io/wasm-workshop/1_prerequisites/#installing-tinygo" target="_blank">these instructions</a> to install TinyGo.</p>
<p>With TinyGo installed, we can download the dependencies and build the extension:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>go mod tidy
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>tinygo build -o main.wasm -scheduler<span class="o">=</span>none -target<span class="o">=</span>wasi main.go
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="go">go: finding module for package github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="go">go: finding module for package github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="go">go: found github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm in github.com/tetratelabs/proxy-wasm-go-sdk v0.17.0</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="go">go: found github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types in github.com/tetratelabs/proxy-wasm-go-sdk v0.17.0</span>
</code></pre></div>
<p>The <code>build</code> command should run successfully and generate a <code>main.wasm</code> file.</p>
<p>We already have the Envoy config, so let's re-run <code>func-e</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>func-e run -c envoy-config.yaml <span class="p">&amp;</span>
</code></pre></div>
<p>This time we won't get any errors because the <code>main.wasm</code> file we referenced in the configuration exists.</p>
<p>Let's try sending a couple of requests to <code>localhost:10000/one</code> to see the custom header we added to the response and the log entries.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>curl -v http://localhost:10000/one
</code></pre></div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="go">*   Trying 127.0.0.1:10000...</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="go">* Connected to localhost (127.0.0.1) port 10000 (#0)</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="go">&gt; GET /one HTTP/1.1</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="go">&gt; Host: localhost:10000</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="go">&gt; User-Agent: curl/7.74.0</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="go">&gt; Accept: */*</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="go">&gt;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="go">[2022-04-28 19:19:39.191][4295][info][wasm] [source/extensions/common/wasm/context.cc:1167] wasm log my_vm: NewHttpContext</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="go">[2022-04-28 19:19:39.194][4295][info][wasm] [source/extensions/common/wasm/context.cc:1167] wasm log my_vm: OnHttpResponseHeaders</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="go">[2022-04-28 19:19:39.194][4295][info][wasm] [source/extensions/common/wasm/context.cc:1167] wasm log my_vm: header set: x-custom-header=custom-value</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="go">* Mark bundle as not supporting multiuse</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="go">&lt; HTTP/1.1 200 OK</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="go">&lt; server: envoy</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="go">&lt; date: Thu, 28 Apr 2022 19:19:39 GMT</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="go">&lt; content-type: application/json</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="go">&lt; content-length: 29</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="go">&lt; access-control-allow-origin: *</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="go">&lt; access-control-allow-credentials: true</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="go">&lt; x-envoy-upstream-service-time: 1</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="hll"><span class="go">&lt; x-custom-header: custom-value</span>
</span><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="go">&lt;</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="go">{</span>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="go">  &quot;origin&quot;: &quot;172.18.0.1&quot;</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="go">}</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="go">* Connection #0 to host localhost left intact</span>
</code></pre></div>
</td></tr></table>
<p>Running the Wasm extension like this is helpful. However, we want to run it next to the Envoy proxies in the Istio service mesh.</p>
<h2 id="istio-wasmplugin-resource">Istio WasmPlugin resource<a class="headerlink" href="#istio-wasmplugin-resource" title="Permanent link">&para;</a></h2>
<p>The WasmPlugin allows us to select the workloads we want to apply the Wasm module to and point to the Wasm module.</p>
<p>The WasmPlugin resource includes a feature that enables the Istio proxy (or istio-agent) to download the Wasm file from an OCI-compliant registry. That means we can treat the Wasm files like we treat Docker images. We can push them to a registry, version them using tags, and reference them from the WasmPlugin resource.</p>
<p>There was no need to push or publish the <code>main.wasm</code> file anywhere in the previous labs, as it was accessible by the Envoy proxy because everything was running locally. However, now that we want to run the Wasm module in Envoy proxies that are part of the Istio service mesh, we need to make the <code>main.wasm</code> file available so all those proxies can load and run it.</p>
<h3 id="building-the-wasm-image">Building the Wasm image<a class="headerlink" href="#building-the-wasm-image" title="Permanent link">&para;</a></h3>
<p>Since we'll be building and pushing the Wasm file, we'll need a very minimal <code>Dockerfile</code> in the project:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">scratch</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">COPY</span><span class="w"> </span>main.wasm ./plugin.wasm
</code></pre></div>
<p>This Docker file copies the <code>main.wasm</code> file to the container as <code>plugin.wasm</code>. Save the above contents to <code>Dockerfile</code>.</p>
<p>Next, we can build and push the Docker image:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nb">export</span> <span class="nv">REPOSITORY</span><span class="o">=[</span>REPOSITORY<span class="o">]</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>docker build -t <span class="si">${</span><span class="nv">REPOSITORY</span><span class="si">}</span>/wasm:v1 .
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>docker push <span class="si">${</span><span class="nv">REPOSITORY</span><span class="si">}</span>/wasm:v1
</code></pre></div>
<details class="note">
<summary>Setting up your registry</summary>
<p>You can use any OCI-compliant registry to host your Wasm files. For example, you can use <a href="https://hub.docker.com">Docker Hub</a>, or if you're using GCP, you can set up the <a href="https://console.cloud.google.com/artifacts">Docker registry here</a>, by clicking the <strong>Create Repository</strong> button, selecting the Docker format and clicking <strong>Create</strong>. Then, follow the setup instructions to complete setting up the GCP registry, and don't forget to <a href="https://cloud.google.com/artifact-registry/docs/access-control">configure access control</a>, so you can push to it and Istio can pull from it.</p>
</details>
<p>You can also use the pre-built images that's available here: <code>europe-west8-docker.pkg.dev/peterjs-project/kubecon2022/wasm:v1</code>.</p>
<h3 id="creating-wasmplugin-resource">Creating WasmPlugin resource<a class="headerlink" href="#creating-wasmplugin-resource" title="Permanent link">&para;</a></h3>
<p>We can now create the WasmPlugin resource that tells Envoy where to download the extension and which workloads to apply it to (we'll use <code>httpbin</code> workload we deployed in the previous lab). </p>
<details class="note" open="open">
<summary>WasmPlugin resource</summary>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">plugin.yaml</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="nx">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="nx">extensions</span><span class="p">.</span><span class="nx">istio</span><span class="p">.</span><span class="nx">io</span><span class="o">/</span><span class="nx">v1alpha1</span><span class="w"></span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="nx">kind</span><span class="p">:</span><span class="w"> </span><span class="nx">WasmPlugin</span><span class="w"></span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="nx">metadata</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">  </span><span class="nx">name</span><span class="p">:</span><span class="w"> </span><span class="nx">wasm</span><span class="o">-</span><span class="nx">example</span><span class="w"></span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">  </span><span class="nx">namespace</span><span class="p">:</span><span class="w"> </span><span class="k">default</span><span class="w"></span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="nx">spec</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">  </span><span class="nx">selector</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="nx">matchLabels</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">      </span><span class="nx">app</span><span class="p">:</span><span class="w"> </span><span class="nx">httpbin</span><span class="w"></span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">  </span><span class="nx">url</span><span class="p">:</span><span class="w"> </span><span class="nx">oci</span><span class="p">:</span><span class="c1">//[REPOSITORY]/wasm:v1</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
</details>
<p>You should update the <code>REPOSITORY</code> value in the <code>url</code> field before saving the above YAML to <code>plugin.yaml</code> and deploying it using <code>kubectl apply -f plugin.yaml</code>.</p>
<p>Let's try out the deployed Wasm module!</p>
<p>Capture the gateway's external IP address:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nv">GATEWAY_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get service istio-ingressgateway -n istio-system -ojsonpath<span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span class="k">)</span>
</code></pre></div>
<p>Because we applied the WasmPlugin to the first <code>httpbin</code> deployment (see the selector labels in the WasmPlugin resource), we can send the request to <code>$GATEWAY_IP/one</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>curl -v <span class="nv">$GATEWAY_IP</span>/one
</code></pre></div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="go">&gt; GET /one HTTP/1.1</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="go">&gt; Host: 34.82.240.26</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="go">&gt; User-Agent: curl/7.74.0</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="go">&gt; Accept: */*</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="go">&gt;</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="go">* Mark bundle as not supporting multiuse</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="go">&lt; HTTP/1.1 200 OK</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="go">&lt; server: istio-envoy</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="go">&lt; date: Thu, 28 Apr 2022 19:33:48 GMT</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="go">&lt; content-type: application/json</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="go">&lt; content-length: 32</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="go">&lt; access-control-allow-origin: *</span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="go">&lt; access-control-allow-credentials: true</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="go">&lt; x-envoy-upstream-service-time: 34</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="hll"><span class="go">&lt; x-custom-header: custom-value</span>
</span><a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="go">&lt;</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="go">{</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="go">  &quot;origin&quot;: &quot;10.138.15.210&quot;</span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="go">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>In this lab, you learned how to create and configure a Wasm extension using Go and the proxy-wasm-go-sdk. You've learned how to run a single Envoy proxy that loads a Wasm extension and use the WasmPlugin resource to deploy the Wasm extension to Envoy proxies inside the Istio service mesh.</p>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../istio/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction to Istio" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Introduction to Istio
            </div>
          </div>
        </a>
      
      
        
        <a href="../summary/" class="md-footer__link md-footer__link--next" aria-label="Next: Summary" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Summary
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © 2022 Tetrate
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.top", "navigation.instant", "navigation.tracking", "content.code.annotate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.22074ed6.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.960e086b.min.js"></script>
      
    
  </body>
</html>